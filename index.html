<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Forex Master - Professional Tick Engine</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --bg: #060d0a; --panel: #0b120f; --border: #1e2a24; --green: #00ff88; --red: #ef5350; --text: #d1d4dc; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: sans-serif; height: 100vh; overflow: hidden; }
        #chart-area { width: 100%; height: 100vh; position: relative; }

        /* 드래그 가능한 플로팅 컨트롤러 */
        #floating-ctrl {
            position: absolute; bottom: 10%; left: 50%; transform: translateX(-50%);
            background: rgba(11, 18, 15, 0.9); border: 1px solid var(--border);
            padding: 10px 25px; border-radius: 40px; z-index: 2000;
            display: flex; align-items: center; gap: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); cursor: move;
            backdrop-filter: blur(10px);
        }

        .play-btn { 
            background: var(--green); border: none; width: 42px; height: 42px; 
            border-radius: 50%; color: black; cursor: pointer; font-size: 16px;
            display: flex; align-items: center; justify-content: center; transition: 0.2s;
        }
        .play-btn:hover { transform: scale(1.1); background: #00e67a; }
        
        .speed-select {
            background: #16261f; border: 1px solid var(--border); color: white;
            padding: 6px 12px; border-radius: 20px; outline: none; cursor: pointer;
            font-size: 13px; font-weight: bold;
        }

        #status-info { font-family: 'Courier New', monospace; font-size: 12px; color: #888; min-width: 180px; text-align: right; }
        .label { font-size: 11px; color: #555; text-transform: uppercase; margin-right: -10px; }
    </style>
</head>
<body>

    <div id="chart-area">
        <div id="floating-ctrl">
            <button class="play-btn" onclick="togglePlay()" id="play-btn">
                <i class="fas fa-play" id="play-icon"></i>
            </button>

            <div style="display:flex; align-items:center; gap:10px;">
                <span class="label">Speed</span>
                <select class="speed-select" id="speed-selector" onchange="setSpeed(this.value)">
                    <option value="0.5">0.5x</option>
                    <option value="1" selected>1x</option>
                    <option value="2">2x</option>
                    <option value="5">5x</option>
                    <option value="10">10x</option>
                    <option value="50">50x</option>
                </select>
            </div>

            <div id="status-info">
                <span id="symbol-name" style="color:var(--green); margin-right:10px;">EUR/USD</span>
                <span id="time-display">READY</span>
            </div>
        </div>
    </div>

    <script>
        // 1. 차트 초기화
        const chart = LightweightCharts.createChart(document.getElementById('chart-area'), {
            layout: { background: { color: '#060d0a' }, textColor: '#d1d4dc' },
            grid: { vertLines: { color: '#111b16' }, horzLines: { color: '#111b16' } },
            timeScale: { borderColor: '#1e2a24', timeVisible: true, secondsVisible: false },
            crosshair: { mode: LightweightCharts.CrosshairMode.Normal }
        });

        const candleSeries = chart.addSeries(LightweightCharts.CandlestickSeries, {
            upColor: '#26a69a', downColor: '#ef5350', borderVisible: false, wickUpColor: '#26a69a', wickDownColor: '#ef5350'
        });

        let allData = [], idx = 100;
        let isPlaying = false;
        let playbackSpeed = 1; 
        let progress = 0; 
        let lastFrameTime = 0;
        let currentH = 0, currentL = 0;

        // 2. 데이터 엔진
        async function fetchHistory() {
            try {
                const res = await fetch(`https://api.binance.com/api/v3/klines?symbol=EURUSDT&interval=1h&limit=1000`);
                const raw = await res.json();
                allData = raw.map(d => ({
                    time: d[0] / 1000,
                    open: parseFloat(d[1]), high: parseFloat(d[2]), low: parseFloat(d[3]), close: parseFloat(d[4])
                }));
                candleSeries.setData(allData.slice(0, idx));
                updateDisplay();
            } catch (e) { console.error("Data Load Error"); }
        }

        // 3. Tick-by-Tick 애니메이션 로직 (Fast Forward 개선)
        function runEngine(timestamp) {
            if (!isPlaying) return;
            if (!lastFrameTime) lastFrameTime = timestamp;

            const delta = (timestamp - lastFrameTime) / 1000; 
            lastFrameTime = timestamp;

            // 배속(playbackSpeed)이 높을수록 progress가 빨리 쌓여 캔들이 광속으로 그려집니다.
            // 기본 1x일 때 약 1.5초마다 한 봉이 완성되도록 밸런스를 잡았습니다.
            progress += delta * (playbackSpeed * 0.7); 

            if (progress >= 1) {
                while(progress >= 1) {
                    progress -= 1;
                    idx++;
                    if (idx >= allData.length) { pause(); return; }
                }
                currentH = allData[idx].open;
                currentL = allData[idx].open;
                updateDisplay();
            }

            const candle = allData[idx];
            let curPrice;
            
            // 캔들 내부 움직임 시뮬레이션
            if (progress < 0.5) {
                let p = progress * 2;
                curPrice = candle.open + (candle.high - candle.open) * p;
            } else {
                let p = (progress - 0.5) * 2;
                curPrice = candle.high - (candle.high - candle.close) * p;
            }

            currentH = Math.max(currentH, curPrice, candle.open);
            currentL = Math.min(currentL, curPrice, candle.open);

            candleSeries.update({
                time: candle.time,
                open: candle.open,
                high: currentH,
                low: currentL,
                close: curPrice
            });

            requestAnimationFrame(runEngine);
        }

        // 4. 컨트롤 함수
        function togglePlay() {
            if (isPlaying) pause();
            else play();
        }

        function play() {
            isPlaying = true;
            lastFrameTime = 0;
            document.getElementById('play-icon').className = 'fas fa-pause';
            requestAnimationFrame(runEngine);
        }

        function pause() {
            isPlaying = false;
            document.getElementById('play-icon').className = 'fas fa-play';
        }

        function setSpeed(val) {
            playbackSpeed = parseFloat(val);
        }

        function updateDisplay() {
            const d = new Date(allData[idx].time * 1000);
            document.getElementById('time-display').innerText = d.toLocaleString();
        }

        // 5. 드래그 인터랙션
        const ctrl = document.getElementById('floating-ctrl');
        let isMoving = false, ox, oy;
        ctrl.onmousedown = (e) => {
            if(e.target.tagName === 'SELECT') return;
            isMoving = true;
            ox = e.clientX - ctrl.offsetLeft;
            oy = e.clientY - ctrl.offsetTop;
        };
        document.onmousemove = (e) => {
            if(isMoving) {
                ctrl.style.left = (e.clientX - ox) + 'px';
                ctrl.style.top = (e.clientY - oy) + 'px';
                ctrl.style.bottom = 'auto';
                ctrl.style.transform = 'none';
            }
        };
        document.onmouseup = () => isMoving = false;

        fetchHistory();
    </script>
</body>
</html>
