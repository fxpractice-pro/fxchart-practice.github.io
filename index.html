<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ForexPractice Master - Tick Engine</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --bg: #060d0a; --panel: #0b120f; --border: #1e2a24; --green: #00ff88; --red: #ef5350; --text: #d1d4dc; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: sans-serif; height: 100vh; overflow: hidden; }
        
        /* 차트 영역 */
        #chart-area { width: 100%; height: 100vh; position: relative; }

        /* 드래그 가능한 플로팅 컨트롤 박스 */
        #floating-ctrl {
            position: absolute; bottom: 10%; left: 50%; transform: translateX(-50%);
            background: rgba(11, 18, 15, 0.9); border: 1px solid var(--border);
            padding: 12px 25px; border-radius: 40px; z-index: 2000;
            display: flex; align-items: center; gap: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); cursor: move;
            backdrop-filter: blur(5px);
        }

        .ctrl-group { display: flex; align-items: center; gap: 15px; }
        .play-btn { 
            background: var(--green); border: none; width: 45px; height: 45px; 
            border-radius: 50%; color: black; cursor: pointer; font-size: 18px;
            display: flex; align-items: center; justify-content: center; transition: 0.2s;
        }
        .play-btn:hover { transform: scale(1.1); }
        
        .speed-select {
            background: #16261f; border: 1px solid var(--border); color: white;
            padding: 5px 10px; border-radius: 5px; outline: none; cursor: pointer;
        }

        #time-display { font-family: monospace; font-size: 13px; color: #888; min-width: 150px; text-align: center; }
    </style>
</head>
<body>

    <div id="chart-area">
        <div id="floating-ctrl">
            <div class="ctrl-group">
                <i class="fas fa-backward tool-icon" style="cursor:pointer; color:#555;"></i>
                <button class="play-btn" onclick="togglePlay()" id="play-icon">
                    <i class="fas fa-play"></i>
                </button>
                <i class="fas fa-forward tool-icon" style="cursor:pointer; color:#555;"></i>
            </div>
            
            <div style="width: 1px; height: 20px; background: #333;"></div>

            <select class="speed-select" onchange="setSpeed(this.value)">
                <option value="0.5">0.5x</option>
                <option value="1" selected>1x</option>
                <option value="2">2x</option>
                <option value="5">5x</option>
                <option value="10">10x</option>
                <option value="50">50x</option>
            </select>

            <div id="time-display">READY</div>
        </div>
    </div>

    <script>
        // 1. 차트 설정
        const chart = LightweightCharts.createChart(document.getElementById('chart-area'), {
            layout: { background: { color: '#060d0a' }, textColor: '#d1d4dc' },
            grid: { vertLines: { color: '#111b16' }, horzLines: { color: '#111b16' } },
            timeScale: { borderColor: '#1e2a24', timeVisible: true, secondsVisible: false }
        });

        const candleSeries = chart.addSeries(LightweightCharts.CandlestickSeries, {
            upColor: '#26a69a', downColor: '#ef5350', borderVisible: false, wickUpColor: '#26a69a', wickDownColor: '#ef5350'
        });

        let allData = [], idx = 0;
        let isPlaying = false;
        let speed = 1; // 기본 배속
        let progress = 0; // 0 ~ 1 사이의 진행도
        let lastTimestamp = 0;
        let currentHigh = 0;
        let currentLow = 0;

        // 2. 바이낸스 데이터 로드
        async function init() {
            const res = await fetch(`https://api.binance.com/api/v3/klines?symbol=EURUSDT&interval=1h&limit=1000`);
            const raw = await res.json();
            allData = raw.map(d => ({
                time: d[0] / 1000,
                open: parseFloat(d[1]),
                high: parseFloat(d[2]),
                low: parseFloat(d[3]),
                close: parseFloat(d[4])
            }));

            idx = 100; // 과거 데이터 100개 먼저 뿌림
            candleSeries.setData(allData.slice(0, idx));
            updateTimeDisplay();
        }

        // 3. 틱 단위 애니메이션 엔진 (핵심)
        function animate(timestamp) {
            if (!isPlaying) return;
            if (!lastTimestamp) lastTimestamp = timestamp;

            const deltaTime = (timestamp - lastTimestamp) / 1000; // 초 단위 소요 시간
            lastTimestamp = timestamp;

            // 배속에 따른 진행도 계산 (1x 속도일 때 1초에 한 봉이 완성되도록 설정됨)
            progress += deltaTime * speed;

            if (progress >= 1) {
                // 한 봉이 완성되면 다음 봉으로
                while (progress >= 1) {
                    progress -= 1;
                    idx++;
                    if (idx >= allData.length) {
                        togglePlay();
                        return;
                    }
                }
                // 새 봉 시작 시 고가/저가 초기화
                currentHigh = allData[idx].open;
                currentLow = allData[idx].open;
                updateTimeDisplay();
            }

            const candle = allData[idx];
            
            // 자연스러운 가격 움직임 시뮬레이션 (Tick-by-tick logic)
            // progress 0~0.5: 시가 -> 고가/저가 도달 과정
            // progress 0.5~1: 고가/저가 -> 종가 도달 과정
            let currentClose;
            if (progress < 0.5) {
                const ratio = progress * 2;
                currentClose = candle.open + (candle.high - candle.open) * ratio;
            } else {
                const ratio = (progress - 0.5) * 2;
                currentClose = candle.high - (candle.high - candle.close) * ratio;
            }

            // 고가와 저가는 실시간으로 갱신
            currentHigh = Math.max(currentHigh, currentClose, candle.open);
            currentLow = Math.min(currentLow, currentClose, candle.open);

            candleSeries.update({
                time: candle.time,
                open: candle.open,
                high: currentHigh,
                low: currentLow,
                close: currentClose
            });

            requestAnimationFrame(animate);
        }

        // 4. 제어 함수들
        function togglePlay() {
            isPlaying = !isPlaying;
            const btn = document.getElementById('play-icon');
            if (isPlaying) {
                btn.innerHTML = '<i class="fas fa-pause"></i>';
                lastTimestamp = 0;
                requestAnimationFrame(animate);
            } else {
                btn.innerHTML = '<i class="fas fa-play"></i>';
            }
        }

        function setSpeed(val) {
            speed = parseFloat(val);
        }

        function updateTimeDisplay() {
            const date = new Date(allData[idx].time * 1000);
            document.getElementById('time-display').innerText = date.toLocaleString();
        }

        // 5. 드래그 로직
        const box = document.getElementById('floating-ctrl');
        let drag = false, rx, ry;
        box.onmousedown = (e) => {
            if(e.target.tagName === 'SELECT') return; // 선택창 클릭시 드래그 방지
            drag = true;
            rx = e.clientX - box.offsetLeft;
            ry = e.clientY - box.offsetTop;
        };
        document.onmousemove = (e) => {
            if(drag) {
                box.style.left = (e.clientX - rx) + 'px';
                box.style.top = (e.clientY - ry) + 'px';
                box.style.bottom = 'auto';
                box.style.transform = 'none';
            }
        };
        document.onmouseup = () => drag = false;

        init();
    </script>
</body>
</html>
