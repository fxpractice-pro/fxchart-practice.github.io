<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Forex Master Pro - Final Engine</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --bg: #060d0a; --panel: #0b120f; --border: #1e2a24; --green: #00ff88; --red: #ef5350; --text: #d1d4dc; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        header { height: 50px; background: var(--panel); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 15px; justify-content: space-between; }
        .nav-btn { background: #16261f; border: 1px solid var(--border); color: var(--text); padding: 5px 12px; cursor: pointer; border-radius: 4px; font-size: 12px; margin-right: 5px; }

        #main-layout { display: flex; flex: 1; position: relative; }

        /* 좌측 툴바 */
        .toolbar { width: 50px; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; padding-top: 20px; gap: 20px; }
        .tool-btn { color: #444; cursor: pointer; font-size: 18px; }
        .tool-btn:hover { color: var(--green); }

        /* 차트 및 플로팅 박스 */
        #chart-container { flex: 1; position: relative; }
        #floating-box {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(11, 18, 15, 0.95); border: 1px solid var(--border);
            padding: 10px 25px; border-radius: 40px; z-index: 9999; display: flex; align-items: center; gap: 15px; cursor: move; box-shadow: 0 8px 30px rgba(0,0,0,0.7);
        }
        .play-btn { background: var(--green); border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; color: black; }
        .speed-sel { background: #1a2e25; border: none; color: white; padding: 5px 10px; border-radius: 15px; font-size: 12px; outline: none; font-weight: bold; }

        /* 우측 매매창 */
        .side-panel { width: 280px; background: var(--panel); border-left: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column; gap: 20px; }
        .price-box { background: #000; padding: 20px; border-radius: 10px; text-align: center; border: 1px solid var(--border); }
        .btn-group { display: flex; gap: 10px; }
        .btn-trade { flex: 1; padding: 15px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; color: white; }
        .ad-slot { flex: 1; border: 1px dashed #333; display: flex; align-items: center; justify-content: center; color: #444; font-size: 11px; margin-top: 10px; }
    </style>
</head>
<body>

<header>
    <div class="assets">
        <button class="nav-btn" onclick="loadSymbol('EURUSDT')">EUR/USD</button>
        <button class="nav-btn" onclick="loadSymbol('GBPUSDT')">GBP/USD</button>
        <button class="nav-btn" onclick="loadSymbol('USDJPY')">USD/JPY</button>
        <button class="nav-btn" onclick="loadSymbol('BTCUSDT')">BTC/USD</button>
        <button class="nav-btn" style="color:var(--green)">+ Indicators</button>
    </div>
    <div id="live-price-header" style="color:var(--green); font-family:monospace; font-weight:bold; font-size:18px;">0.00000</div>
</header>

<div id="main-layout">
    <div class="toolbar">
        <i class="fas fa-mouse-pointer tool-btn" style="color:var(--green)"></i>
        <i class="fas fa-slash tool-btn"></i>
        <i class="fas fa-square tool-btn"></i>
        <i class="fas fa-circle tool-btn"></i>
        <i class="fas fa-arrow-up tool-btn"></i>
        <i class="fas fa-eraser tool-btn"></i>
    </div>

    <div id="chart-container">
        <div id="floating-box">
            <button class="play-btn" onclick="handlePlay()"><i class="fas fa-play" id="play-icon"></i></button>
            <select class="speed-sel" onchange="window.speedMultiplier = parseFloat(this.value)">
                <option value="0.5">0.5x</option>
                <option value="1" selected>1x</option>
                <option value="2">2x</option>
                <option value="5">5x</option>
                <option value="10">10x</option>
                <option value="50">50x</option>
            </select>
            <span id="time-tag" style="font-size:11px; color:#666; font-family:monospace; min-width:130px;">READY</span>
        </div>
    </div>

    <aside class="side-panel">
        <div class="price-box">
            <div style="font-size:11px; color:#444; margin-bottom:5px;">REALTIME PRICE</div>
            <div id="side-live-price" style="font-size:26px; font-weight:bold; color:var(--green);">0.00000</div>
        </div>
        <div class="btn-group">
            <button class="btn-trade" style="background:var(--red);">SELL</button>
            <button class="btn-trade" style="background:var(--green); color:black;">BUY</button>
        </div>
        <div class="ad-slot">CPC AD SPACE</div>
        <div class="ad-slot" style="max-height:80px;">BOTTOM AD</div>
    </aside>
</div>

<script>
    // 전역 변수 설정
    window.speedMultiplier = 1;
    let chart, candleSeries, allData = [], currentIndex = 150, isPlaying = false, animationId;
    let currentProgress = 0, lastTimestamp = 0;
    let curH = 0, curL = 0;

    // 1. 차트 초기화 (스케일 오류 방지 로직 포함)
    function initChart() {
        const container = document.getElementById('chart-container');
        chart = LightweightCharts.createChart(container, {
            layout: { background: { color: '#060d0a' }, textColor: '#d1d4dc' },
            grid: { vertLines: { color: '#111b16' }, horzLines: { color: '#111b16' } },
            timeScale: { borderColor: '#1e2a24', timeVisible: true, rightOffset: 15 },
            rightPriceScale: { 
                borderColor: '#1e2a24', 
                autoScale: true, // 강제 스케일링
                scaleMargins: { top: 0.2, bottom: 0.2 } 
            }
        });

        candleSeries = chart.addSeries(LightweightCharts.CandlestickSeries, {
            upColor: '#26a69a', downColor: '#ef5350', borderVisible: false, wickUpColor: '#26a69a', wickDownColor: '#ef5350',
            priceFormat: { type: 'price', precision: 5, minMove: 0.00001 }
        });

        // 윈도우 리사이즈 대응
        window.addEventListener('resize', () => chart.applyOptions({ width: container.clientWidth, height: container.clientHeight }));
    }

    // 2. 데이터 불러오기
    async function loadSymbol(symbol) {
        isPlaying = false;
        cancelAnimationFrame(animationId);
        document.getElementById('play-icon').className = 'fas fa-play';
        
        try {
            const res = await fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=1h&limit=1000`);
            const raw = await res.json();
            allData = raw.map(d => ({
                time: d[0] / 1000, open: parseFloat(d[1]), high: parseFloat(d[2]), low: parseFloat(d[3]), close: parseFloat(d[4])
            }));
            
            currentIndex = 150;
            candleSeries.setData(allData.slice(0, currentIndex));
            chart.timeScale().fitContent(); // 초기 비율 최적화
            updateUI();
        } catch (e) { console.error("Data Error"); }
    }

    // 3. 틱 단위 자연스러운 애니메이션 루프
    function tickLoop(timestamp) {
        if (!isPlaying) return;
        if (!lastTimestamp) lastTimestamp = timestamp;
        
        const delta = (timestamp - lastTimestamp) / 1000;
        lastTimestamp = timestamp;
        
        // 배속에 따른 진행도 계산 (0.5x ~ 50x 대응)
        currentProgress += delta * (window.speedMultiplier * 0.7);

        if (currentProgress >= 1) {
            while(currentProgress >= 1) {
                currentProgress -= 1;
                currentIndex++;
                if (currentIndex >= allData.length) { isPlaying = false; return; }
            }
            curH = allData[currentIndex].open;
            curL = allData[currentIndex].open;
            // 새 봉이 생길 때 차트가 가격을 다시 맞추도록 유도
        }

        const data = allData[currentIndex];
        // 봉 내부 움직임 시뮬레이션
        let currentPrice;
        if (currentProgress < 0.5) {
            currentPrice = data.open + (data.high - data.open) * (currentProgress * 2);
        } else {
            currentPrice = data.high - (data.high - data.close) * ((currentProgress - 0.5) * 2);
        }

        curH = Math.max(curH, currentPrice);
        curL = Math.min(curL, currentPrice);

        candleSeries.update({
            time: data.time, open: data.open, high: curH, low: curL, close: currentPrice
        });

        updateUI(currentPrice);
        animationId = requestAnimationFrame(tickLoop);
    }

    function updateUI(price) {
        const p = price ? price.toFixed(5) : allData[currentIndex].close.toFixed(5);
        document.getElementById('live-price-header').innerText = p;
        document.getElementById('side-live-price').innerText = p;
        document.getElementById('time-tag').innerText = new Date(allData[currentIndex].time * 1000).toLocaleString();
    }

    function handlePlay() {
        isPlaying = !isPlaying;
        document.getElementById('play-icon').className = isPlaying ? 'fas fa-pause' : 'fas fa-play';
        if (isPlaying) {
            lastTimestamp = 0;
            animationId = requestAnimationFrame(tickLoop);
        }
    }

    // 4. 드래그 로직 (플로팅 컨트롤러 전용)
    const box = document.getElementById('floating-box');
    let drag = false, ox, oy;
    box.onmousedown = (e) => { if(e.target.tagName === 'SELECT') return; drag = true; ox = e.clientX - box.offsetLeft; oy = e.clientY - box.offsetTop; };
    document.onmousemove = (e) => { if(drag) { box.style.left = (e.clientX - ox) + 'px'; box.style.top = (e.clientY - oy) + 'px'; box.style.bottom = 'auto'; box.style.transform = 'none'; } };
    document.onmouseup = () => drag = false;

    initChart();
    loadSymbol('EURUSDT');
</script>
</body>
</html>
